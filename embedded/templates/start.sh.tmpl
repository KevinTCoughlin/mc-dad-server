#!/usr/bin/env bash
set -euo pipefail
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

MEMORY="${MC_MEMORY:-{{.Memory}}}"
GC_TYPE="${MC_GC_TYPE:-{{.GCType}}}"

# Detect Java
if [[ -n "${JAVA_HOME:-}" && -x "$JAVA_HOME/bin/java" ]]; then
    JAVA_CMD="$JAVA_HOME/bin/java"
else
    JAVA_CMD="java"
fi

# Build JVM flags
JVM_FLAGS=(
    -Xms"$MEMORY"
    -Xmx"$MEMORY"
)

if [[ "${GC_TYPE,,}" == "zgc" ]]; then
    # ZGC — low latency collector (requires Java 21+)
    JVM_FLAGS+=(
        -XX:+UseZGC
        -XX:+ZGenerational
        -XX:+AlwaysPreTouch
        -XX:+DisableExplicitGC
        -XX:+PerfDisableSharedMem
    )
else
    # G1GC — Aikar's flags optimized for Minecraft
    # https://docs.papermc.io/paper/aikars-flags
    JVM_FLAGS+=(
        -XX:+UseG1GC
        -XX:+ParallelRefProcEnabled
        -XX:MaxGCPauseMillis=200
        -XX:+UnlockExperimentalVMOptions
        -XX:+DisableExplicitGC
        -XX:+AlwaysPreTouch
        -XX:G1NewSizePercent=30
        -XX:G1MaxNewSizePercent=40
        -XX:G1HeapRegionSize=8M
        -XX:G1ReservePercent=20
        -XX:G1HeapWastePercent=5
        -XX:G1MixedGCCountTarget=4
        -XX:InitiatingHeapOccupancyPercent=15
        -XX:G1MixedGCLiveThresholdPercent=90
        -XX:G1RSetUpdatingPauseTimePercent=5
        -XX:SurvivorRatio=32
        -XX:+PerfDisableSharedMem
        -XX:MaxTenuringThreshold=1
        -Dusing.aikars.flags=https://mcflags.emc.gs
        -Daikars.new.flags=true
    )
fi

{{if .EnableBun}}
# Bun scripting sidecar
BUN_DIR="$SCRIPT_DIR/bun-scripts"
if [[ -d "$BUN_DIR" ]] && command -v bun &>/dev/null; then
    echo "Starting Bun scripting sidecar..."
    (cd "$BUN_DIR" && bun run runtime/index.ts) &
    BUN_PID=$!
    cleanup() { kill "$BUN_PID" 2>/dev/null; wait "$BUN_PID" 2>/dev/null; }
    trap cleanup EXIT INT TERM
fi
{{end}}

echo "Starting Minecraft server with ${MEMORY} RAM (${GC_TYPE^^} GC)..."
{{if .EnableBun}}
"$JAVA_CMD" "${JVM_FLAGS[@]}" -jar server.jar nogui
{{else}}
exec "$JAVA_CMD" "${JVM_FLAGS[@]}" -jar server.jar nogui
{{end}}
