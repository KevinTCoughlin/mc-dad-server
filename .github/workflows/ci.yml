name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      container: ${{ steps.filter.outputs.container }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - '.golangci.yml'
              - '.github/workflows/ci.yml'
              - 'internal/configs/embedded/**'
            container:
              - 'Containerfile'
              - 'entrypoint.sh'
              - 'compose.yml'

  checks:
    name: Checks
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum
      - name: Vet
        run: go vet ./...
      - uses: golangci/golangci-lint-action@v6
        with:
          version: latest

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - run: go test -race ./...

  test-cross-platform:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: changes
    if: needs.changes.outputs.code == 'true' && github.event_name == 'push'
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - run: go test -race ./...

  build:
    name: Build (all targets)
    runs-on: ubuntu-latest
    needs: [checks, test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: build --snapshot --clean

  hadolint:
    name: Hadolint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.container == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Containerfile

  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.container == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: ShellCheck entrypoint.sh
        run: shellcheck entrypoint.sh
